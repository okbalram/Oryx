steps:
# Azure Key Vault
# Download Azure Key Vault secrets
- task: AzureKeyVault@1
  inputs:
    azureSubscription: oryxSP
    keyVaultName: Oryx
    secretsFilter: '*'
    runAsPreJob: false # Azure DevOps Services only

- script: |
    az version
    printenv
    echo "List of containers dead/alive ..." 
    docker ps -a
    echo "List of images ..."
    docker images 
    echo "Cleaning containers and images ..."
    docker system prune -af
    echo "List of containers dead/alive ..." 
    docker ps -a
    echo "List of images ..."
    docker images
  displayName: 'Remove all existing docker images from machine'

- task: ShellScript@2
  displayName: 'Publish SDKs from dev to prod storage account'
  env:
    DEV_STORAGE_SAS_TOKEN: $(DEV-STORAGE-SAS-TOKEN)
    PROD_STORAGE_SAS_TOKEN: $(PROD-STORAGE-SAS-TOKEN)
  inputs:
    scriptPath: ./vsts/scripts/publishSdksFromDevToProdStorageAccount.sh

- script: |
    echo "Restarting in 1 minutes" 
    sudo shutdown -r +1
  displayName: 'Restart machine after cleaning up'
